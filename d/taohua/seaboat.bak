// Copyright (C) 2003, by Lonely. All rights reserved.
// This software can not be used, copied, or modified 
// in any form without the written permission from authors.

#include <ansi.h>
inherit ROOM;

string long_desc();
void do_ready();
void do_drop();
void reset();

void create()
{
        set("short", "æµ·èˆ¹");
        set("long", @LONG
è¿™æ˜¯ä¸€è‰˜å¾ˆæ™®é€šçš„æ¸”èˆ¹ï¼Œå‡ åæ°´æ‰‹æ‘†å¼„ç€å¸†ç¯·ï¼Œç¯™æ¡¨ï¼Œç»³ç´¢ï¼Œå’Œèˆ¹å°¾
æœ¨èˆµã€‚ä»¥ä¸‹æŒ‡ä»¤æœ‰åŠ©äºä½ çš„èˆªè¡Œï¼š(1)startï¼Œ(2)stopï¼Œ(3)goï¼Œ(4)looko
utï¼Œ(5)locateã€‚[34må››å‘¨æ˜¯è¾½é˜”çš„æµ·é¢ï¼Œæµ·é£åœ¨ä½ è€³è¾¹è½»è½»å¹è¿‡ï¼Œæµ·æµª
ä¸€ä¸ªæ¥ä¸€ä¸ªå‘èˆ¹æ³¼æ‰“è¿‡æ¥ã€‚[2ï¼›37ï¼›0m
LONG );
        set("invalid_startroom", 1);

        set("cost", 5);
        set("outdoors", "taohua");

        setup();
}

string long_desc()
{
        string desc;

        desc ="è¿™æ˜¯ä¸€è‰˜å¾ˆæ™®é€šçš„æ¸”èˆ¹ï¼Œå‡ åæ°´æ‰‹æ‘†å¼„ç€å¸†ç¯·ï¼Œç¯™æ¡¨ï¼Œç»³ç´¢ï¼Œå’Œèˆ¹å°¾æœ¨èˆµã€‚\n";
        desc += "ä»¥ä¸‹æŒ‡ä»¤æœ‰åŠ©äºä½ çš„èˆªè¡Œï¼š(1)start, (2)stop, (3)go, (4)lookout, (5)locateã€‚\n\n";

        if( !query("exits/out") )
                switch((int)query_temp("navigate/weather")) {
                        case 1: desc += BLU"å¤©ç©ºä¸­å½¤äº‘å¯†å¸ƒï¼Œåªæœ‰å‡ åªæµ·é¸¥è¿˜åœ¨å¥‹åŠ›å±•ç¿…ï¼Œæµ·èˆ¹å·¦å³æ‘‡æ™ƒä¸å·²ï¼Œä½ æ„Ÿåˆ°æœ‰\nç‚¹ç«‹è¶³ä¸ç¨³ã€‚\n"NOR; break;
                        case 2: desc += BLU"æµ·é¢æ±¹æ¶Œæ¾æ¹ƒï¼Œå‡ ä¸ˆé«˜çš„å·¨æµªæ’å±±å€’æµ·ä¼¼å¾—å‹æ¥ï¼Œéšæ—¶éƒ½æœ‰å¯èƒ½å°†èˆ¹æ€ç¿»ï¼Œä½ \næ—¶è€Œä¸å¾—ä¸ç´§ç´§æŠ±ä½èˆ¹æ†ï¼Œä»¥å…è½æµ·ã€‚\n"NOR; break;
                        default: desc += BLU"å››å‘¨æ˜¯è¾½é˜”çš„æµ·é¢ï¼Œæµ·é£åœ¨ä½ è€³è¾¹è½»è½»å¹è¿‡ï¼Œæµ·æµªä¸€ä¸ªæ¥ä¸€ä¸ªå‘èˆ¹æ³¼æ‰“è¿‡æ¥ã€‚\n"NOR;  break;
                }
        return desc;
}

void init()
{
        add_action("do_start", "start");
        add_action("do_go", "go");
        add_action("do_stop", "stop");
        add_action("do_lookout", "lookout");
        add_action("do_locate", "locate");
        add_action("do_start", "1");
        add_action("do_go", "3");
        add_action("do_stop", "2");
        add_action("do_lookout", "4");
        add_action("do_locate", "5");
}

int do_start()
{
        mixed inv;
        object shipside, me = this_player();

        inv = filter_array(all_inventory(this_object()), "is_owner", this_object(), me);
        if( sizeof(inv) > 0 )
                return notify_fail("é•¿è¿™ä¹ˆå¤§è¿ä¸€ç‚¹æ±Ÿæ¹–è§„çŸ©éƒ½ä¸æ‡‚ï¼Ÿ\n");

        if( !query("exits/out") )
                return notify_fail("èˆ¹å·²ç»å‡ºæµ·äº†ã€‚\n");

        if( !(shipside = find_object(query("exits/out"))) )
                shipside = load_object(query("exits/out"));

        switch(query("short", shipside)){
                case "èˆŸå±±":
                        set_temp("navigate/locx", 0);
                        set_temp("navigate/locy", 0);
                        break;
                case "æ¸¯æ¹¾":
                        set_temp("navigate/locx", 35);
                        set_temp("navigate/locy", 35);
                        break;
                case "æµ·æ»©":
                        set_temp("navigate/locx", 35);
                        set_temp("navigate/locy", 35);
                        break;
        }

        message("vision", "æ¸”èˆ¹ç¦»äº†å²¸ï¼Œé©¶å‘èŒ«èŒ«çš„å¤§æµ·ã€‚\n", shipside);
        delete("exits/enter", shipside);

        message_vision("$Nå¤§å–ä¸€å£°â€œå¼€èˆ¹â€ï¼Œäºæ˜¯èˆ¹ä¾¿ç¦»äº†å²¸ã€‚\n", me);
        delete("exits/out");

        call_out("shipweather", 1);
        call_out("navigate", 1);
        set_temp("navigate/control", 1);

        return 1;
}

int navigate()
{
        object dest, *inv, *invofusr;
        string dir;
        int i, m, locx, locy, step;

        if( !random(40) && !query("exist/out")
        &&  query_temp("navigate/weather") == 2 ) {
                tell_room(this_object(), HIR"\nçªç„¶é—´ç‹‚é£å¤§ä½œï¼Œä¸ä¸€ä¼šå„¿èˆ¹å°±ç¿»äº†ï¼\n\n"NOR);
                do_drop();
                return 1;
        }

        if( query_temp("navigate/locx") > 100 + random(50)
        || query_temp("navigate/locy") > 100 + random(50) ){
                tell_room(this_object(), HIR"\nçªç„¶é—´ç‹‚é£å¤§ä½œï¼Œä¸ä¸€ä¼šå„¿èˆ¹å°±ç¿»äº†ï¼\n\n"NOR);
                do_drop();
                return 1;
        }

        if( !(dir = (string)query_temp("navigate/dir")) ) {
                if( !random(40) ) {
                        addn_temp("navigate/wait", 1);
                        if( query_temp("navigate/wait") > 5 ) {
                                tell_room(this_object(), "èˆ¹å¤«ä»¬æŠŠå¤§å®¶éƒ½æ‰”è¿›äº†æµ·é‡Œã€‚\n");
                                do_drop();
                                return 1;
                        }
                        tell_room(this_object(),"æ°´æ‰‹ä»¬æ­£ç­‰ç€ä½ ä¸‹ä»¤å¯èˆªï¼\n");
                }                        
                call_out("navigate", 1);
                return 1;
        }       

        step = 1 + random(2);
        switch(dir) {
                case "ä¸œ":
                        addn_temp("navigate/locx", step);
                        break;
                case "å—":
                        addn_temp("navigate/locy", -step);
                        break;
                case "è¥¿":
                        addn_temp("navigate/locx", -step);
                        break;
                case "åŒ—":
                        addn_temp("navigate/locy", step);
                        break;
                default:
                        call_out("navigate", 1);
                        return 1;
        }

        locx = query_temp("navigate/locx");
        if( locx < 0 ) {
                tell_room(this_object(),"ä½ åªè§‰è„šä¸‹ä¸€æ²‰ï¼Œèˆ¹ä¼¼ä¹å·²ç»ç¢°åˆ°äº†é™†åœ°ã€‚\n");
                set("exits/out", __DIR__"zhoushan");

                delete_temp("navigate");
                call_out("do_ready", 20 + random(10));

                dest = find_object(__DIR__"zhoushan");
                set("exits/enter", __DIR__"seaboat", dest);
                message("vision", "ä¸€æ¡æ¸”èˆ¹é©¶äº†è¿‡æ¥ã€‚\n", dest);
                return 1;
        }

        locy = query_temp("navigate/locy");
        if( locx >= 38 && locx <= 43 
        &&  locy >= 38 && locy <=43 ) {
                tell_room(this_object(),"èˆ¹å¤«è¯´ï¼šâ€œæ¡ƒèŠ±å²›åˆ°å•¦ï¼Œå¿«ä¸Šå²¸å§ï¼Œæˆ‘å¯ä¸æ„¿æ„åœ¨è¿™é¬¼åœ°æ–¹å¤šå¾…ï¼â€ã€‚\n");
                set("exits/out", __DIR__"haitan");

                delete_temp("navigate");
                call_out("do_ready", 20 + random(10));

                  dest = find_object(__DIR__"haitan");
//                dest->set("exits/enter", __DIR__"seaboat");
//                message("vision", "ä¸€æ¡æ¸”èˆ¹é©¶äº†è¿‡æ¥ã€‚\n", dest);
                tell_room(dest, "ä¸€æ¡æ¸”èˆ¹é©¶äº†è¿‡æ¥ã€‚\n");
                return 1;
        }

        if( !random(3) )
                tell_room(this_object(), "èˆ¹æ­£å¾€" + dir + "æ–¹å‘å‰è¿›ã€‚\n");
        call_out("navigate", 1);

        return 1;
}

int do_go(string arg)
{
        string dir;
        object me = this_player();
        mixed inv;

        if( query("exits/out") )
                return notify_fail("èˆ¹è¿˜æ²¡å¼€å‘¢ã€‚\n");

        if( !query_temp("navigate/control") ) {
                call_out("shipweather", 1);
                call_out("navigate", 1);
                set_temp("navigate/control", 1);
        }

        inv = filter_array(all_inventory(this_object()), "is_owner", this_object(), me);
        if( sizeof(inv) > 0 )
                return notify_fail("é•¿è¿™ä¹ˆå¤§è¿ä¸€ç‚¹æ±Ÿæ¹–è§„çŸ©éƒ½ä¸æ‡‚ï¼Ÿ\n");

        switch(arg) {
                case "e":
                case "east": 
                        dir = "ä¸œ";
                        break;
                case "s": 
                case "south": 
                        dir = "å—";
                        break;
                case "w": 
                case "west": 
                        dir = "è¥¿";
                        break;
                case "n": 
                case "north": 
                        dir = "åŒ—";
                        break;
                default:
                        return notify_fail("ä½ è¦èˆ¹å¾€å“ªä¸ªæ–¹å‘å¼€ï¼Ÿ\n");
        }

        set_temp("navigate/dir", dir);
        message_vision("$Nå¯¹èˆ¹å¤«ç¤ºæ„æœ" + dir + "å¼€ã€‚\n", me);
        return 1;
}

int do_stop()
{
        object me = this_player();
        mixed inv;

        inv = filter_array(all_inventory(this_object()), "is_owner", this_object(), me);
        if( sizeof(inv) > 0 )
                return notify_fail("é•¿è¿™ä¹ˆå¤§è¿ä¸€ç‚¹æ±Ÿæ¹–è§„çŸ©éƒ½ä¸æ‡‚ï¼Ÿ\n");

        if( !query_temp("navigate/dir") )
                return notify_fail("èˆ¹å·²ç»åœäº†ã€‚\n");

        message_vision("$Nå«èˆ¹å¤«ä»¬æŠŠèˆ¹åœä¸€åœã€‚\n", me);
        delete_temp("navigate/dir");

        return 1;
}

int do_lookout()
{
        string dir;
        int locx, locy;

        if( query("exits/out") ) {
                tell_object(this_player(), "èˆ¹è¿˜æ²¡å¼€å‘¢ã€‚\n");
                return 1;
        }

        locx = (int)query_temp("navigate/locx");

        if( locx < 0 ) {
                tell_object(this_player(), "ä½ å·²ç»åœ¨å¤§é™†å²¸è¾¹äº†ã€‚\n");
                return 1;
        }

        if( locx < 6 ) {
                tell_object(this_player(), "ä½ æç›®è¿œçœºï¼Œå‘ç°è¥¿é¢ä¸è¿œå¤„å°±æ˜¯å¤§é™†ã€‚\n");
                return 1;
        }

        locy = (int)query_temp("navigate/locy");

        if( locx >= 38 && locx <= 43
        && locy >=38 && locy >= 43 ) {
                tell_object(this_player(), "ä½ å·²ç»åœ¨æ¡ƒèŠ±å²›å²¸è¾¹äº†ã€‚\n");
                return 1;
        }

        if( (locy > 20 && locy < 40) && (locx > 20 && locx < 40) )
                dir = "ä¸œåŒ—";
        else if( (locy > 20 && locy < 40) && locx == 40 )
                dir = "åŒ—";
        else if( (locy > 20 && locy < 40) && (locx > 40 && locx < 60) )
                dir = "è¥¿åŒ—";
        else if( locy == 40 && (locx > 20 && locx < 40) )
                dir = "ä¸œ";
        else if( locy == 40 && (locx > 40 && locx < 60) )
                dir = "è¥¿";
        else if( (locy > 40 && locy < 60) && (locx > 20 && locx < 40) )
                dir = "ä¸œå—";
        else if( (locy > 40 && locy < 60) && locx == 40 )
                dir = "å—";
        else if( (locy > 40 && locy < 60) && (locx > 40 && locx < 60) )
                dir = "è¥¿å—";

        if( dir )
                tell_object(this_player(), "ä½ æç›®è¿œçœºï¼Œå‘ç°æ¡ƒèŠ±å²›å°±åœ¨" +dir + "æ–¹å‘ã€‚\n");
        else    tell_object(this_player(), "ä½ æç›®è¿œçœºï¼Œåªè§‰å¤§æµ·èŒ«èŒ«ã€‚\n");

        return 1;
}

int do_locate()
{
        string dir;
        int locx, locy;

        if( query("exits/out") ) {
                tell_object(this_player(), "èˆ¹è¿˜æ²¡å¼€å‘¢ã€‚\n");
                return 1;
        }

        locx = (int)query_temp("navigate/locx");

        if( locx < 0 ) {
                tell_object(this_player(), "ä½ å·²ç»åœ¨å¤§é™†å²¸è¾¹äº†ã€‚\n");
                return 1;
        }

        locy = (int)query_temp("navigate/locy");

        if( locx >= 38 && locx <= 43 
        && locy >= 38 && locy <=43 ) {
                tell_object(this_player(), "ä½ å·²ç»åœ¨æ¡ƒèŠ±å²›å²¸è¾¹äº†ã€‚\n");
                return 1;
        }

        locx = (locx * 9 + random(locx * 2 ))/10;
        locy = (locy * 9 + random(locy * 2 ))/10;

        if( locy > 0 ) 
                dir = "ä¸œ" + chinese_number(locx) + "æµ·å“©" + "åŒ—çº¦" + chinese_number(locy) + "æµ·å“©";
        else if( locy < 0 )
                dir = "ä¸œçº¦" + chinese_number(locx) + "æµ·å“©" + "å—çº¦" + chinese_number(-locy) + "æµ·å“©";
        else    dir = "æ­£ä¸œçº¦" + chinese_number(locx) + "æµ·å“©";

        tell_object(this_player(), "ä½ ç°åœ¨åœ¨èˆŸå±±" + dir + "å¤„ã€‚\n");

        return 1;
}

private is_owner(object ob, object me)
{
        if( living(ob) && userp(ob) && ob != me
         && query("combat_exp", ob)>query("combat_exp", me) )
                return 1;

        return 0;
}

void shipweather()
{
        if( !filter_array(all_inventory(this_object()), (:userp:)) )
                return;

        if( query("exits/out") ) return;
//        if( !mapp(query_temp("navigate")) ) return;

        if( !query_temp("navigate/weather") ) {
                if( !random(6) ) {
                        set_temp("navigate/weather", 1);
                        remove_call_out("niceweather");
                        call_out("niceweather", 5 + random(10));
                } else  if( !random(24) ) {
                        set_temp("navigate/weather", 2);
                        remove_call_out("niceweather");
                        call_out("niceweather", 5 + random(10));
                }
        }

        if( !query_temp("navigate/weather") )
                call_out("shipweather", 1);
}

void niceweather()
{
        set_temp("navigate/weather", 0);
        call_out("shipweather", 1);
}

void do_drop()
{
        object *inv, *invofusr;
        int i, m;

        inv = all_inventory(this_object());
        for( i = 0; i < sizeof(inv); i++ ) {
                if( userp(inv[i]) ) {
                        inv[i]->unconcious();
                        invofusr = all_inventory(inv[i]);
                        for(m = 0; m < sizeof(invofusr); m++)
                                destruct(invofusr[m]);
                        if( random(8) == 1 )
                                inv[i]->move("/d/taohua/haitan");
                        else    inv[i]->move("/d/taohua/zhoushan");
                        message("vision",
                        "ä½ å‘ç°ä¸€ä¸ªæµ‘èº«æ°´æ·‹æ·‹çš„å®¶ä¼™è¢«æµ·æ°´å†²ä¸Šå²¸æ¥ï¼Œä¸ç”±å¾—èµ°è¿‘ä¸€çœ‹ï¼ŒåŸæ¥æ˜¯"+query("name", inv[i])+"ã€‚\n",environment(inv[i]),({inv[i]}));
                } else  destruct(inv[i]);
        }

        delete_temp("navigate");
        delete_temp("trigger");
}

void do_ready()
{
        object shipside;

        if( !query_temp("trigger") || !query("exits/out") )
                return;

        if( !(shipside = find_object(query("exits/out"))) )
                shipside = load_object(query("exits/out"));

        switch(query("short", shipside)){
                case "èˆŸå±±":
                        set_temp("navigate/locx", 0);
                        set_temp("navigate/locy", 0);
                        break;
                case "æ¸¯æ¹¾":
                        set_temp("navigate/locx", 35);
                        set_temp("navigate/locy", 35);
                        break;
                case "æµ·æ»©":
                        set_temp("navigate/locx", 35);
                        set_temp("navigate/locy", 35);
                        break;
        }

        message("vision", "æ¸”èˆ¹ç¦»äº†å²¸ï¼Œé©¶å‘èŒ«èŒ«çš„å¤§æµ·ã€‚\n", shipside);
        delete("exits/enter", shipside);

        delete_temp("trigger");
        delete("exits/out");
        message("vision", "èˆ¹å¤«ä»¬æ”¶é”šæ‰¬å¸†ï¼Œäºæ˜¯èˆ¹ä¾¿ç¦»äº†å²¸ã€‚\n",this_object());
}

void reset()
{
        object shipside;

        ::reset();

        if( !(shipside = find_object(__DIR__"zhoushan")) )
                shipside = load_object(__DIR__"zhoushan");

        if( query("exits/enter", shipside) )
                delete("exits/enter", shipside);

        if( !(shipside = find_object(__DIR__"harbor")) )
                shipside = load_object(__DIR__"harbor");

        if( query("exits/enter", shipside) )
                delete("exits/enter", shipside);
}